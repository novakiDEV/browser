<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>cnvrs Browser</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #0f0f11;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }
        ::-webkit-scrollbar {
            display: none;
        }
        .custom-titlebar {
            height: 40px;
            background-color: #0f0f11;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 12px 0 8px;
            -webkit-app-region: drag;
            position: relative;
            z-index: 1000;
            gap: 8px;
        }
        .titlebar-spacer {
            width: 140px;
            min-width: 140px;
            height: 100%;
            -webkit-app-region: drag;
        }
        .custom-titlebar button, .tabs-button {
            background: transparent;
            border: none;
            color: transparent;
            font-size: 12px;
            height: 24px;
            width: 24px;
            cursor: pointer;
            -webkit-app-region: no-drag;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            transition: background-color 0.2s ease;
        }
        .custom-titlebar button:hover, .tabs-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        .custom-titlebar button img, .tabs-button img {
            width: 12px;
            height: 12px;
            filter: brightness(0) saturate(100%) invert(43%) sepia(6%) saturate(1059%) hue-rotate(202deg) brightness(95%) contrast(89%);
            transition: filter 0.2s ease;
        }
        .custom-titlebar button:hover img, .tabs-button:hover img {
            filter: brightness(0) saturate(100%) invert(76%) sepia(4%) saturate(424%) hue-rotate(202deg) brightness(94%) contrast(85%);
        }
        .url-container {
            flex: 1;
            display: flex;
            align-items: center;
            background-color: #1e1e21;
            border: 1px solid #2a2d33;
            border-radius: 12px;
            padding: 0 16px;
            height: 24px;
            box-sizing: border-box;
            position: relative;
            justify-content: center;
        }
        .favicon {
            width: 12px;
            height: 12px;
            opacity: 0.8;
            position: absolute;
            pointer-events: none;
        }
        .url-bar {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            font-size: 12px;
            color: #6b6f7c;
            outline: none;
            -webkit-app-region: no-drag;
            font-weight: 400;
            opacity: 0.9;
            transition: color 0.2s ease;
            text-align: center;
            padding-left: 22px;
        }
        .url-bar:focus {
            color: #c0c0c0;
        }
        .tabs-dropdown {
            position: relative;
            -webkit-app-region: no-drag;
        }
        .tabs-button {
            padding: 0;
            user-select: none;
        }
        .tabs-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 28px;
            background-color: #151518;
            border: 1px solid #2a2d33;
            border-radius: 6px;
            min-width: 220px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1100;
            font-size: 12px;
            color: #c0c0c0;
        }
        .tabs-dropdown-content.show {
            display: block;
        }
        .tab-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px;
            cursor: pointer;
            border-bottom: 1px solid #2a2d33;
            user-select: none;
        }
        .tab-item:last-child {
            border-bottom: none;
        }
        .tab-item:hover {
            background-color: #2a2d33;
        }
        .tab-item.active {
            background-color: #3a3d44;
            font-weight: bold;
        }
        .tab-close-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-left: 8px;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
        }
        .tab-close-btn img {
            width: 10px;
            height: 10px;
            filter: brightness(0) saturate(100%) invert(53%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(88%) contrast(89%);
            transition: filter 0.2s ease;
        }
        .tab-close-btn:hover img {
            filter: brightness(0) saturate(100%) invert(27%) sepia(51%) saturate(2878%) hue-rotate(346deg) brightness(104%) contrast(97%);
        }
        .add-tab-btn {
            display: block;
            padding: 6px 10px;
            cursor: pointer;
            border-top: 1px solid #2a2d33;
            text-align: center;
            color: #6b6f7c;
            user-select: none;
        }
        .add-tab-btn:hover {
            background-color: #2a2d33;
            color: #c0c0c0;
            font-weight: bold;
        }
        .content-area {
            height: calc(100vh - 40px);
            background-color: #0f0f11;
            padding: 0 8px 8px 8px;
            box-sizing: border-box;
            display: flex;
            gap: 8px;
        }
        .sidebar {
            width: 0;
            height: 100%;
            overflow: hidden;
            transition: width 0.3s ease;
            flex-shrink: 0;
            display: none;
        }
        .sidebar.open {
            width: 250px;
        }
        .content-box {
            flex: 1;
            height: 100%;
            background-color: #151518;
            border-radius: 8px;
            border: 1px solid #2a2d33;
            box-sizing: border-box;
            overflow: hidden;
            position: relative;
        }
        .webview-container {
            width: 100%;
            height: 100%;
            border-radius: 7px;
            overflow: hidden;
        }
        webview {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div class="custom-titlebar">
        <button id="back-button"><img src="assets/back.png" alt="Back"></button>
        <button id="forward-button"><img src="assets/forward.png" alt="Forward"></button>
        <button id="reload-button"><img src="assets/refresh.png" alt="Refresh"></button>
        <button id="settings-button"><img src="assets/settings.png" alt="Settings"></button>
        <div class="url-container">
            <input type="text" class="url-bar" placeholder="Enter URL or search query">
            <img class="favicon" id="favicon" src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236b6f7c'><circle cx='12' cy='12' r='10'/></svg>" alt="Favicon">
        </div>
        <div class="tabs-dropdown">
            <button class="tabs-button" id="tabs-button" title="Tabs">
                <img src="assets/tabs.png" alt="Tabs">
            </button>
            <div class="tabs-dropdown-content" id="tabs-dropdown-content">
                <div class="add-tab-btn" id="add-tab-btn">+ New Tab</div>
            </div>
        </div>
        <div class="titlebar-spacer"></div>
    </div>
    <div class="content-area">
        <div class="sidebar" id="sidebar">
        </div>
        <div class="content-box">
            <div class="webview-container" id="webview-container">
                <webview id="webview" src="https://google.com/" allowpopups prefers-color-scheme="dark" webpreferences="contextIsolation=false,enableRemoteModule=true,contextMenu=true"></webview>
            </div>
        </div>
    </div>
    <script>
        const tabsButton = document.getElementById('tabs-button');
        const tabsDropdownContent = document.getElementById('tabs-dropdown-content');
        const addTabBtn = document.getElementById('add-tab-btn');
        const urlBar = document.querySelector('.url-bar');
        const faviconImg = document.getElementById('favicon');
        const webviewContainer = document.getElementById('webview-container');
        let tabs = [];
        let currentTabId = null;
        let tabIdCounter = 0;
        function createWebview(url, tabId) {
            const webview = document.createElement('webview');
            Object.assign(webview, {
                allowpopups: '',
                'prefers-color-scheme': 'dark',
                webpreferences: 'contextIsolation=false,enableRemoteModule=true,contextMenu=true'
            });
            Object.assign(webview.style, {
                width: '100%',
                height: '100%',
                border: 'none'
            });
            webview.dataset.tabId = tabId;
            webview.src = url;

            ['did-navigate', 'did-navigate-in-page'].forEach(event => {
                webview.addEventListener(event, (e) => {
                    if (tabId === currentTabId) {
                        updateUrlBar(e.url);
                        updateFavicon(e.url);
                    }
                    updateTab(tabId, 'url', e.url);
                    updateTab(tabId, 'title', webview.getTitle());
                    renderTabs();
                });
            });

            webview.addEventListener('page-title-updated', (e) => {
                updateTab(tabId, 'title', e.title);
                renderTabs();
            });

            webview.addEventListener('dom-ready', () => {
                if (tabId === currentTabId) {
                    updateUrlBar(webview.src);
                    updateFavicon(webview.src);
                }
            });

            webview.addEventListener('did-fail-load', (event) => {
                if (event.errorCode === -105) {
                    webview.src = 'pages/error/105.html';
                }
            });

            return webview;
        }
        function addTab(url = 'https://google.com/') {
            const id = ++tabIdCounter;
            const title = 'New Tab';
            const tab = { id, title, url };
            tabs.push(tab);
            clearWebview();
            const webview = createWebview(url, id);
            webviewContainer.appendChild(webview);
            currentTabId = id;
            updateUrlBar(url);
            renderTabs();
        }
        function switchTab(id) {
            if (id === currentTabId) return;
            currentTabId = id;
            clearWebview();
            const tab = tabs.find(t => t.id === id);
            if (!tab) return;
            const webview = createWebview(tab.url, id);
            webviewContainer.appendChild(webview);
            updateUrlBar(tab.url);
            updateFavicon(tab.url);
            renderTabs();
        }
        function closeTab(id) {
            const index = tabs.findIndex(t => t.id === id);
            if (index === -1) return;
            tabs.splice(index, 1);
            if (tabs.length === 0) {
                addTab();
                return;
            }
            if (currentTabId === id) {
                const nextTab = tabs[index] || tabs[index - 1];
                if (nextTab) {
                    switchTab(nextTab.id);
                }
            } else {
                renderTabs();
            }
        }
        function clearWebview() {
            while (webviewContainer.firstChild) {
                webviewContainer.removeChild(webviewContainer.firstChild);
            }
        }
        function updateTab(id, property, value) {
            const tab = tabs.find(t => t.id === id);
            if (tab) {
                if (property === 'title' && value) {
                    tab.title = value.length > 30 ? value.slice(0, 27) + '...' : value;
                } else {
                    tab[property] = value;
                }
            }
        }
        function renderTabs() {
            const existingTabs = Array.from(tabsDropdownContent.querySelectorAll('.tab-item'));
            existingTabs.forEach(node => node.remove());
            tabs.forEach(tab => {
                const tabItem = document.createElement('div');
                tabItem.classList.add('tab-item');
                if (tab.id === currentTabId) tabItem.classList.add('active');
                tabItem.textContent = tab.title || tab.url;
                tabItem.addEventListener('click', () => {
                    switchTab(tab.id);
                    toggleTabsDropdown(false);
                });
                const closeBtn = document.createElement('button');
                closeBtn.classList.add('tab-close-btn');
                closeBtn.title = 'Close Tab';
                
                const closeIcon = document.createElement('img');
                closeIcon.src = 'assets/close.png';
                closeIcon.alt = 'Close';
                closeBtn.appendChild(closeIcon);
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeTab(tab.id);
                });
                tabItem.appendChild(closeBtn);
                tabsDropdownContent.insertBefore(tabItem, addTabBtn);
            });
        }
        function toggleTabsDropdown(show) {
            if (typeof show === 'boolean') {
                tabsDropdownContent.classList.toggle('show', show);
            } else {
                tabsDropdownContent.classList.toggle('show');
            }
        }
        document.addEventListener('click', (event) => {
            if (!tabsDropdownContent.contains(event.target) && !tabsButton.contains(event.target)) {
                toggleTabsDropdown(false);
            }
        });
        tabsButton.addEventListener('click', () => {
            toggleTabsDropdown();
        });
        addTabBtn.addEventListener('click', () => {
            addTab();
            toggleTabsDropdown(false);
        });
        function formatUrl(input) {
            input = input.trim();
            if (input.startsWith('http://') || input.startsWith('https://')) {
                return input;
            }
            if (input.startsWith('www.')) {
                return 'https://' + input;
            }
            const urlPattern = /^(?:[a-z0-9]+(?:-[a-z0-9]+)*\.)+[a-z]{2,}(\/.*)?$/i;
            if (urlPattern.test(input)) {
                return 'https://' + input;
            }
            return null;
        }
        function navigateToUrl(url) {
            const webview = getCurrentWebview();
            if (webview) {
                webview.src = url;
                updateTab(currentTabId, 'url', url);
            }
        }
        function updateUrlBar(url, forEditing = false) {
            try {
                const urlObj = new URL(url);
                let displayUrl = urlObj.hostname.replace(/^www\./, '');
                
                if (forEditing) {
                    if (urlObj.pathname !== '/') displayUrl += urlObj.pathname;
                    if (urlObj.search) displayUrl += urlObj.search;
                }
                
                urlBar.value = displayUrl;
                urlBar.dataset.fullUrl = url;
                positionFavicon();
            } catch (e) {
                urlBar.value = url;
                urlBar.dataset.fullUrl = url;
                positionFavicon();
            }
        }
        
        function positionFavicon() {
            if (urlBar.value.trim() === '') {
                faviconImg.style.display = 'none';
                return;
            }
            
            const measureSpan = document.createElement('span');
            measureSpan.style.position = 'absolute';
            measureSpan.style.visibility = 'hidden';
            measureSpan.style.fontSize = '12px';
            measureSpan.style.fontFamily = window.getComputedStyle(urlBar).fontFamily;
            measureSpan.style.fontWeight = '400';
            measureSpan.textContent = urlBar.value;
            document.body.appendChild(measureSpan);
            
            const textWidth = measureSpan.offsetWidth;
            document.body.removeChild(measureSpan);
            
            faviconImg.style.display = 'block';
            const containerWidth = urlBar.offsetWidth;
            const textStartPosition = (containerWidth / 2) - (textWidth / 2);
            faviconImg.style.left = textStartPosition + 'px';
        }
        
        function updateFavicon(url) {
            try {
                const urlObj = new URL(url);
                const faviconUrl = `${urlObj.protocol}//${urlObj.hostname}/favicon.ico`;
                
                const testImg = new Image();
                testImg.onload = () => {
                    faviconImg.src = faviconUrl;
                    positionFavicon();
                };
                testImg.onerror = () => {
                    faviconImg.src = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236b6f7c'><circle cx='12' cy='12' r='10'/></svg>";
                    positionFavicon();
                };
                testImg.src = faviconUrl;
            } catch (e) {
                faviconImg.src = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236b6f7c'><circle cx='12' cy='12' r='10'/></svg>";
                positionFavicon();
            }
        }
        urlBar.addEventListener('focus', () => {
            if (urlBar.dataset.fullUrl) updateUrlBar(urlBar.dataset.fullUrl, true);
        });

        urlBar.addEventListener('blur', () => {
            if (urlBar.dataset.fullUrl) updateUrlBar(urlBar.dataset.fullUrl, false);
        });

        urlBar.addEventListener('input', positionFavicon);

        window.addEventListener('resize', positionFavicon);

        urlBar.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const input = urlBar.value.trim();
                if (!input) return;
                
                const url = formatUrl(input);
                const finalUrl = url || `https://www.google.com/search?q=${encodeURIComponent(input)}`;
                navigateToUrl(finalUrl);
                urlBar.blur();
            }
        });

        ['back', 'forward', 'reload'].forEach(action => {
            document.getElementById(`${action}-button`).addEventListener('click', () => {
                const webview = getCurrentWebview();
                if (!webview) return;
                
                if (action === 'back' && webview.canGoBack()) webview.goBack();
                else if (action === 'forward' && webview.canGoForward()) webview.goForward();
                else if (action === 'reload') webview.reload();
            });
        });
        function getCurrentWebview() {
            return webviewContainer.querySelector('webview');
        }

        document.getElementById('settings-button').addEventListener('click', () => {
            window.location.href = 'pages/settings.html';
        });
        window.addEventListener('DOMContentLoaded', () => {
            addTab('https://google.com/');
        });
    </script>
</body>
</html>
